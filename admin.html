<!-- templates/admin.html -->
<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Crypto Training</title>
<link rel="icon" href="/logo.png">
<style>
  body{font-family:system-ui; margin:0; background:#071024; color:#e6eef8}
  header{display:flex; align-items:center; gap:12px; padding:12px; background:linear-gradient(90deg,#06203a,#08304d)}
  .logo{height:36px}
  .wrap{padding:18px; max-width:980px; margin:0 auto}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .card{background:#062035; padding:12px; border-radius:12px; flex:1 1 320px}
  input,textarea{width:100%; padding:8px; border-radius:8px; margin-top:6px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit}
  button{padding:10px 12px; border-radius:8px; border:0; background:#06b6d4; color:#042a2b; font-weight:700; cursor:pointer}
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th,td{padding:8px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left}
</style>
</head>
<body>
<header><img src="/logo.png" class="logo"><h3 style="margin:0">Admin</h3></header>
<div class="wrap">
  <div class="row">
    <div class="card">
      <h3>Admin login</h3>
      <p>Enter admin password (default: admin123).</p>
      <input id="admin_pw" placeholder="Admin password">
      <button onclick="loginAdmin()">Login</button>
      <div id="adminMsg" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>Generate PIN</h3>
      <input id="note" placeholder="Optional note (user name/email)">
      <button onclick="generatePin()">Generate 6-digit PIN</button>
      <div id="newPin" style="margin-top:8px; font-weight:700"></div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card">
      <h3>Upload Video</h3>
      <input id="video_title" placeholder="Title">
      <input id="video_file" type="file" accept="video/*">
      <button onclick="uploadVideo()">Upload</button>
      <div id="uploadMsg" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>Pins (latest)</h3>
      <div id="pinsWrapper">Please login to see pins.</div>
    </div>
  </div>

  <div style="margin-top:20px" class="card">
    <h3>Uploaded Videos</h3>
    <div id="videosWrapper">Please login to see videos.</div>
  </div>
</div>

<script>
  // admin password stored client-side temporarily and sent via header for admin-only API calls
  let ADMIN_PW = null;

  function loginAdmin(){
    ADMIN_PW = document.getElementById('admin_pw').value || '';
    document.getElementById('adminMsg').innerText = "Admin password set in this tab.";
    refreshPins();
    refreshVideos();
  }

  async function generatePin(){
    if(!ADMIN_PW){ alert('Enter admin password first'); return; }
    const note = document.getElementById('note').value || '';
    const res = await fetch('/api/admin/generate_pin', {
      method:'POST',
      headers: {'Content-Type':'application/json', 'X-ADMIN-PW': ADMIN_PW},
      body: JSON.stringify({note})
    });
    const j = await res.json();
    if(j.success){
      document.getElementById('newPin').innerText = "New pin: " + j.pin;
      refreshPins();
    } else {
      document.getElementById('newPin').innerText = "Error: " + (j.error || 'server');
    }
  }

  async function uploadVideo(){
    if(!ADMIN_PW){ alert('Enter admin password first'); return; }
    const title = document.getElementById('video_title').value || '';
    const f = document.getElementById('video_file').files[0];
    if(!title || !f){ alert('Provide title and file'); return; }
    const fd = new FormData();
    fd.append('title', title);
    fd.append('video', f);
    fd.append('admin_pw', ADMIN_PW);
    const res = await fetch('/api/admin/upload_video', {method:'POST', body:fd});
    const j = await res.json();
    if(j.success) {
      document.getElementById('uploadMsg').innerText = 'Uploaded ✓';
      refreshVideos();
    } else {
      document.getElementById('uploadMsg').innerText = 'Upload failed: ' + (j.error||'');
    }
  }

  async function refreshPins(){
    if(!ADMIN_PW){ document.getElementById('pinsWrapper').innerText = 'Please login to view pins.'; return; }
    const res = await fetch('/api/admin/pins', {headers:{'X-ADMIN-PW': ADMIN_PW}});
    const j = await res.json();
    if(!Array.isArray(j)){ document.getElementById('pinsWrapper').innerText = 'Auth required.'; return; }
    let html = '<table><tr><th>ID</th><th>PIN</th><th>Note</th><th>Device</th><th>IP</th><th>Revoked</th><th>Action</th></tr>';
    for(const p of j){
      html += `<tr><td>${p.id}</td><td>${p.pin}</td><td>${p.note||''}</td><td>${p.device_id||''}</td><td>${p.ip||''}</td><td>${p.revoked? 'YES':''}</td>` +
        `<td>${p.revoked? '': `<button onclick="revokePin(${p.id})">Revoke</button>`}</td></tr>`;
    }
    html += '</table>';
    document.getElementById('pinsWrapper').innerHTML = html;
  }

  async function revokePin(id){
    if(!ADMIN_PW) return alert('Login first');
    const res = await fetch('/api/admin/revoke_pin', {
      method:'POST',
      headers: {'Content-Type':'application/json', 'X-ADMIN-PW': ADMIN_PW},
      body: JSON.stringify({pin_id:id})
    });
    const j = await res.json();
    if(j.success){ refreshPins(); }
    else alert('Failed to revoke');
  }

  async function refreshVideos(){
    if(!ADMIN_PW){ document.getElementById('videosWrapper').innerText = 'Please login to view videos.'; return; }
    const res = await fetch('/api/videos'); // no auth needed for metadata
    const j = await res.json();
    if(!Array.isArray(j)){ document.getElementById('videosWrapper').innerText = 'No videos'; return; }
    let html = '<table><tr><th>Title</th><th>Uploaded</th></tr>';
    for(const v of j){
      html += `<tr><td>${v.title}</td><td>${v.uploaded_at}</td></tr>`;
    }
    html += '</table>';
    document.getElementById('videosWrapper').innerHTML = html;
  }
</script>
</body>
</html>
