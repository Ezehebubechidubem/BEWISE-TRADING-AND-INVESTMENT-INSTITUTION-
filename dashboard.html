<!-- dashboard.html
     Dashboard page (inline CSS + JS)
     Checks session and ensures the device fingerprint matches the allowed device.
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — Crypto Training</title>
<link rel="icon" href="/logo.png">
<style>
  body{ margin:0; font-family:system-ui,Segoe UI; background:linear-gradient(180deg,#031025,#071024); color:#e6eef8; }
  header{ display:flex; align-items:center; gap:12px; padding:14px; background:linear-gradient(90deg,#06203a,#08304d);}
  .logo{ height:36px }
  .container{ padding:20px; max-width:980px; margin:auto }
  .card{ background:#062035; padding:18px; border-radius:12px; box-shadow:0 8px 20px rgba(2,6,23,0.6) }
  .links a{ display:inline-block; margin-right:10px; padding:10px 12px; border-radius:10px; text-decoration:none; background:#06b6d4; color:#042a2b; font-weight:700 }
  #status{ margin-top:12px; opacity:0.9 }
  button.logout{ background:#ef4444; color:white; border:0; padding:8px 12px; border-radius:8px; cursor:pointer }
</style>
</head>
<body>
<header>
  <img src="/logo.png" class="logo" alt="logo">
  <div>
    <div style="font-weight:700">Crypto Training</div>
    <div style="font-size:12px;opacity:0.85">Member dashboard</div>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2 id="who">Welcome</h2>
    <p>Use links to access courses, payment or admin (if you are admin).</p>
    <div class="links">
      <a href="/course">Courses</a>
      <a href="/payment">Payment</a>
      <a id="adminLink" href="/admin" style="display:none">Admin</a>
      <button class="logout" id="logoutBtn">Logout</button>
    </div>
    <div id="status"></div>
  </div>
</div>

<script>
(async function(){
  // compute local fingerprint same as authentication page
  async function getFP(){
    try {
      let uuid = localStorage.getItem('training_device_uuid');
      if(!uuid){ uuid = crypto.randomUUID ? crypto.randomUUID() : ('u-'+Math.random().toString(36).slice(2)); localStorage.setItem('training_device_uuid', uuid); }
      const vals = [navigator.userAgent, navigator.platform, (navigator.languages||[]).join(','), screen.width+'x'+screen.height+'x'+screen.colorDepth, Intl.DateTimeFormat().resolvedOptions().timeZone||'', uuid].join('||');
      const enc = new TextEncoder().encode(vals);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    } catch(e){ return localStorage.getItem('training_device_uuid') || 'local-fallback'; }
  }

  const fp = await getFP();
  const allowed = localStorage.getItem('training_allowed_device');
  if(allowed && allowed !== fp){
    alert('This site is locked to another device. Redirecting to login.');
    window.location.href = '/';
    return;
  }

  // check server session
  try {
    const r = await fetch('/api/check_session');
    const j = await r.json();
    if(!j.logged_in){
      // not logged in -> back to login
      window.location.href = '/';
      return;
    }
    document.getElementById('who').innerText = 'Welcome — device registered';
    document.getElementById('status').innerText = 'Device ID (short): ' + fp.slice(0,8) + (sessionStorage.getItem('training_is_admin') ? ' — Admin' : '');
    if(sessionStorage.getItem('training_is_admin')) document.getElementById('adminLink').style.display = 'inline-block';
  } catch(e){
    console.error(e);
    alert('Server error. Try refreshing.');
  }

  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    await fetch('/api/logout', { method:'POST' });
    sessionStorage.removeItem('training_is_admin');
    window.location.href = '/';
  });
})();
</script>
</body>
</html>