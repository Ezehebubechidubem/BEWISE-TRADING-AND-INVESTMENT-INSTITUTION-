<!-- course.html -->
<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Courses</title>
<link rel="icon" href="/logo.png">
<style>
  body{font-family:system-ui;margin:0;background:linear-gradient(180deg,#031025,#071024);color:#e6eef8}
  header{display:flex;align-items:center;gap:12px;padding:12px;background:linear-gradient(90deg,#06203a,#08304d)}
  .logo{height:36px}
  .wrap{padding:18px;max-width:1100px;margin:auto}
  .intro{opacity:0.9;margin-bottom:14px}
  /* toggle */
  .switch-wrap{display:flex;gap:12px;justify-content:center;margin-bottom:18px}
  .switch-btn{
    padding:12px 18px;border-radius:12px;border:0;cursor:pointer;font-weight:800;font-size:1rem;
    background:linear-gradient(90deg,#0b1220,#061427); color:#cfefff; box-shadow:0 8px 20px rgba(0,0,0,0.45);
    transition:transform .12s, box-shadow .12s;
  }
  .switch-btn.active{ background:linear-gradient(90deg,#06b6d4,#0891b2); color:#042a2b; transform:translateY(-3px); box-shadow:0 16px 30px rgba(0,0,0,0.5); }
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
  .card{background:#062035;padding:12px;border-radius:12px;position:relative;overflow:hidden}
  video{width:100%;border-radius:8px;background:black}
  /* file card */
  .file-card{display:flex;flex-direction:column;gap:10px;align-items:flex-start;justify-content:center;padding:18px}
  .file-preview{width:100%;border-radius:8px;background:#04080b;display:flex;align-items:center;justify-content:center;min-height:140px;color:#cfefff;overflow:hidden}
  .file-meta{font-weight:700;margin-top:8px}
  .file-actions{display:flex;gap:8px;margin-top:8px}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn-download{background:linear-gradient(90deg,#4ade80,#16a34a);color:#04210b}
  .btn-open{background:linear-gradient(90deg,#1e88ff,#0b63d6);color:#fff}
  .note{opacity:0.85;font-size:0.95rem;margin-bottom:6px}
  /* Modal */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:9999; }
  .modal-panel{ background:#0b1220; padding:18px; border-radius:10px; width:92%; max-width:520px; box-shadow:0 12px 40px rgba(0,0,0,0.6); color:#e6eef8 }
  .modal-title{ font-weight:800; margin-bottom:8px; font-size:1.05rem }
  .modal-body{ margin-bottom:12px; color:#cfefff; line-height:1.3 }
  .modal-actions{ display:flex; gap:8px; justify-content:flex-end; }
  .btn-secondary{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:#cfefff; padding:8px 10px; border-radius:8px; cursor:pointer }
  .btn-primary{ background:linear-gradient(90deg,#06b6d4,#0891b2); color:#042a2b; padding:8px 12px; border-radius:8px; font-weight:800; cursor:pointer }
  @media (max-width:520px){
    .switch-btn{ width:48%; font-size:0.95rem; padding:10px; }
  }
</style>
</head>
<body>
<header><img src="/logo.png" class="logo" alt="logo"><div style="font-weight:700">Courses</div></header>
<div class="wrap">
  <p class="intro">Watch course videos below. Downloading is blocked (best-effort). Use the switch to view Videos or Files (images, PDFs, resources).</p>

  <div class="switch-wrap" role="tablist" aria-label="Choose content">
    <button id="btnVideos" class="switch-btn active" role="tab" aria-selected="true">Videos</button>
    <button id="btnFiles" class="switch-btn" role="tab" aria-selected="false">Files</button>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>
</div>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal-panel" role="document" aria-live="polite" aria-modal="true">
    <div class="modal-title" id="modalTitle">Title</div>
    <div class="modal-body" id="modalBody">Message</div>
    <div class="modal-actions" id="modalActions">
      <button class="btn-secondary" id="modalCancel">Cancel</button>
      <button class="btn-primary" id="modalOk">OK</button>
    </div>
  </div>
</div>

<script>
(async function(){
  // Modal utilities (replaces alert)
  const backdrop = document.getElementById('modalBackdrop');
  const titleEl = document.getElementById('modalTitle');
  const bodyEl = document.getElementById('modalBody');
  const okBtn = document.getElementById('modalOk');
  const cancelBtn = document.getElementById('modalCancel');
  function showModal(title, message, { showCancel=false, okText='OK', cancelText='Cancel' } = {}){
    titleEl.innerText = title || '';
    bodyEl.innerText = message || '';
    okBtn.innerText = okText;
    cancelBtn.innerText = cancelText;
    cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');
    return new Promise(resolve=>{
      function cleanup(){ okBtn.removeEventListener('click', onOk); cancelBtn.removeEventListener('click', onCancel); backdrop.style.display='none'; backdrop.setAttribute('aria-hidden','true'); }
      function onOk(){ cleanup(); resolve(true); }
      function onCancel(){ cleanup(); resolve(false); }
      okBtn.addEventListener('click', onOk);
      cancelBtn.addEventListener('click', onCancel);
    });
  }
  const showMessage = (t,m) => showModal(t,m,{showCancel:false,okText:'OK'});
  const showConfirm = (t,m) => showModal(t,m,{showCancel:true,okText:'Yes',cancelText:'No'});

  // fingerprint & session checks (same logic)
  async function computeFP(){
    let uuid = localStorage.getItem('training_device_uuid');
    if(!uuid){ uuid = crypto.randomUUID ? crypto.randomUUID() : ('u-'+Math.random().toString(36).slice(2)); localStorage.setItem('training_device_uuid', uuid); }
    const data = [navigator.userAgent||'', navigator.platform||'', (navigator.languages||[]).join(','), screen.width+'x'+screen.height+'x'+screen.colorDepth, Intl.DateTimeFormat().resolvedOptions().timeZone||'', uuid].join('||');
    const enc = new TextEncoder().encode(data);
    const hashBuf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  const fp = await computeFP();
  const allowed = localStorage.getItem('training_allowed_device');
  if(allowed && allowed !== fp){
    await showMessage('Device locked','This installation is locked to another device.');
    location.href='/'; return;
  }

  // check session
  try{
    const chk = await (await fetch('/api/check_session')).json();
    if(!chk.logged_in){ location.href='/'; return; }
  }catch(e){
    console.error('check_session failed',e);
    await showMessage('Error','Unable to verify session. Redirecting to login.'); location.href='/'; return;
  }

  // fetch helpers
  async function safeJson(url, opts){ try { const r = await fetch(url, opts); if(!r.ok){ return {ok:false,status:r.status}; } const j = await r.json(); return {ok:true,body:j}; } catch(e){ return {ok:false,error:e}; } }

  // UI refs
  const btnVideos = document.getElementById('btnVideos');
  const btnFiles = document.getElementById('btnFiles');
  const grid = document.getElementById('grid');

  // state
  let videos = [];
  let files = [];

  // loaders
  async function loadVideos(){
    const res = await safeJson('/api/videos');
    if(res.ok && Array.isArray(res.body)) videos = res.body; else videos = [];
  }
  async function loadFiles(){
    // try public then admin files endpoint
    const candidates = ['/api/files','/api/admin/files'];
    let got = false;
    for(const ep of candidates){
      const r = await safeJson(ep);
      if(r.ok && Array.isArray(r.body)){ files = r.body; got = true; break; }
    }
    if(!got) files = [];
  }

  // renderers
  function renderVideos(){
    grid.innerHTML = '';
    if(!Array.isArray(videos) || videos.length===0){
      grid.innerHTML = '<div style="opacity:0.8">No videos yet.</div>'; return;
    }
    videos.forEach(v=>{
      const card = document.createElement('div'); card.className='card';
      const vid = document.createElement('video'); vid.controls=true; vid.setAttribute('controlsList','nodownload nofullscreen noremoteplayback'); vid.src = '/stream/'+v.id;
      vid.onplay = async ()=>{ try { const j = await (await fetch('/api/check_session')).json(); if(!j.logged_in){ vid.pause(); await showMessage('Login required','Please login'); location.href='/'; } } catch(e){ vid.pause(); await showMessage('Error','Session check failed'); location.href='/'; } };
      const t = document.createElement('div'); t.style.marginTop='8px'; t.style.fontWeight='700'; t.innerText = v.title || 'Untitled';
      card.appendChild(vid); card.appendChild(t); grid.appendChild(card);
    });
  }

  function extFromFilename(name){
    if(!name) return '';
    const m = name.split('.'); return (m.length>1?m.pop().toLowerCase():'');
  }

  function renderFiles(){
    grid.innerHTML = '';
    if(!Array.isArray(files) || files.length===0){
      grid.innerHTML = '<div style="opacity:0.8">No files yet.</div>'; return;
    }
    files.forEach(f=>{
      const card = document.createElement('div'); card.className='card file-card';
      const preview = document.createElement('div'); preview.className='file-preview';
      const filename = f.filename || '';
      const title = f.title || filename || 'Untitled';
      const ext = extFromFilename(filename);
      // image inline
      if(['png','jpg','jpeg','gif','webp','bmp','svg'].includes(ext)){
        const img = document.createElement('img'); img.style.maxWidth='100%'; img.style.height='auto'; img.style.borderRadius='8px';
        img.src = '/download/file/' + encodeURIComponent(f.id);
        img.alt = title;
        preview.appendChild(img);
      } else if(ext === 'pdf'){
        // embed pdf preview (iframe)
        const ifr = document.createElement('iframe'); ifr.src = '/download/file/' + encodeURIComponent(f.id); ifr.style.width='100%'; ifr.style.height='260px'; ifr.style.border='0'; preview.appendChild(ifr);
      } else {
        // generic icon + filename
        const txt = document.createElement('div'); txt.innerText = ext ? ext.toUpperCase() : 'FILE'; txt.style.fontWeight='800'; preview.appendChild(txt);
      }
      const meta = document.createElement('div'); meta.className='file-meta'; meta.innerText = title + (f.uploaded_at?(' — ' + (new Date(f.uploaded_at)).toLocaleString()):'');
      const actions = document.createElement('div'); actions.className='file-actions';
      const open = document.createElement('a'); open.className='btn btn-open'; open.innerText='Open'; open.href = '/download/file/' + encodeURIComponent(f.id); open.target='_blank'; open.rel='noopener noreferrer';
      const dl = document.createElement('a'); dl.className='btn btn-download'; dl.innerText='Download'; dl.href = '/download/file/' + encodeURIComponent(f.id); dl.download = ''; dl.target='_blank'; dl.rel='noopener noreferrer';
      actions.appendChild(open); actions.appendChild(dl);
      card.appendChild(preview); card.appendChild(meta); card.appendChild(actions); grid.appendChild(card);
    });
  }

  // initial load
  await loadVideos();
  await loadFiles();
  renderVideos();

  // switch handlers
  function setActive(isVideos){
    if(isVideos){
      btnVideos.classList.add('active'); btnFiles.classList.remove('active');
      btnVideos.setAttribute('aria-selected','true'); btnFiles.setAttribute('aria-selected','false');
      renderVideos();
    } else {
      btnFiles.classList.add('active'); btnVideos.classList.remove('active');
      btnFiles.setAttribute('aria-selected','true'); btnVideos.setAttribute('aria-selected','false');
      renderFiles();
    }
  }
  btnVideos.addEventListener('click', ()=> setActive(true));
  btnFiles.addEventListener('click', ()=> setActive(false));

  // protections & polish
  document.addEventListener('contextmenu', e=>e.preventDefault());
  document.addEventListener('visibilitychange', ()=>{ document.querySelectorAll('video').forEach(v=> v.style.filter = document.visibilityState === 'visible' ? 'none' : 'blur(6px)'); });

})();
</script>
</body>
</html>