<!-- course.html -->
<!doctype html>
<html>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Courses</title>
<link rel="icon" href="/logo.png">
<style>
  body{font-family:system-ui;margin:0;background:linear-gradient(180deg,#031025,#071024);color:#e6eef8}
  header{display:flex;align-items:center;gap:12px;padding:12px;background:linear-gradient(90deg,#06203a,#08304d)}
  .logo{height:36px}
  .wrap{padding:18px;max-width:1100px;margin:auto}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
  .card{background:#062035;padding:12px;border-radius:12px}
  video{width:100%;border-radius:8px;background:black}
</style>
</head>
<body>
<header><img src="/logo.png" class="logo"><div style="font-weight:700">Courses</div></header>
<div class="wrap">
  <p style="opacity:0.9">Watch course videos below. Downloading is blocked (best-effort).</p>
  <div id="grid" class="grid"></div>
</div>

<script>
(async function(){
  async function computeFP(){
    let uuid = localStorage.getItem('training_device_uuid');
    if(!uuid){ uuid = crypto.randomUUID ? crypto.randomUUID() : ('u-'+Math.random().toString(36).slice(2)); localStorage.setItem('training_device_uuid', uuid); }
    const data = [navigator.userAgent || '', navigator.platform || '', (navigator.languages || []).join(','), screen.width+'x'+screen.height+'x'+screen.colorDepth, Intl.DateTimeFormat().resolvedOptions().timeZone || '', uuid].join('||');
    const enc = new TextEncoder().encode(data);
    const hashBuf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  const myfp = await computeFP();
  const allowed = localStorage.getItem('training_allowed_device');
  if(allowed && allowed !== myfp){ alert('This installation is locked to another device.'); location.href='/'; return; }
  const chk = await (await fetch('/api/check_session')).json();
  if(!chk.logged_in){ location.href='/'; return; }

  const res = await fetch('/api/videos');
  const vids = await res.json();
  const grid = document.getElementById('grid');
  if(!Array.isArray(vids) || vids.length===0){ grid.innerHTML='<div style="opacity:0.8">No videos yet.</div>'; return; }
  vids.forEach(v=>{
    const card = document.createElement('div'); card.className='card';
    const vid = document.createElement('video'); vid.controls=true; vid.setAttribute('controlsList','nodownload nofullscreen noremoteplayback'); vid.src = '/stream/'+v.id;
    vid.onplay = async ()=>{ const j = await (await fetch('/api/check_session')).json(); if(!j.logged_in){ vid.pause(); alert('Please login'); location.href='/'; } };
    const t = document.createElement('div'); t.style.marginTop='8px'; t.style.fontWeight='700'; t.innerText = v.title || 'Untitled';
    card.appendChild(vid); card.appendChild(t); grid.appendChild(card);
  });
  document.addEventListener('contextmenu', e=>e.preventDefault());
  document.addEventListener('visibilitychange', ()=>{ document.querySelectorAll('video').forEach(v=> v.style.filter = document.visibilityState === 'visible' ? 'none' : 'blur(6px)'); });
})();
</script>
</body>
</html>