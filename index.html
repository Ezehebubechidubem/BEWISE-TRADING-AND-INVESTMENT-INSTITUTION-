<!-- templates/authentication.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Authentication — Crypto Training</title>
<link rel="icon" href="/logo.png">
<style>
  /* Inline CSS - keep it simple & mobile-first */
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto; background:#0f172a; color:#e6eef8; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; }
  .card { background: linear-gradient(180deg,#0b1220, #0f1b38); padding:20px; border-radius:12px; width:92vw; max-width:420px; box-shadow: 0 10px 30px rgba(2,6,23,0.6); }
  h1{ margin:0 0 8px; font-size:20px; text-align:center}
  .logo { display:block; margin:0 auto 12px; width:140px; height:42px; object-fit:contain }
  input[type="text"]{ width:100%; padding:14px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; font-size:18px; text-align:center; letter-spacing:6px; }
  button{ width:100%; padding:12px; margin-top:12px; border-radius:8px; border:0; background:#06b6d4; color:#042a2b; font-weight:700; font-size:16px; cursor:pointer; }
  .note{ font-size:13px; opacity:0.8; margin-top:10px; text-align:center; }
  .danger{ color:#ffb4b4; font-weight:700; }
</style>
</head>
<body>
  <div class="card">
    <img src="/logo.png" class="logo" alt="logo">
    <h1>Enter your 6-digit PIN</h1>
    <input id="pin" type="text" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="••••••" />
    <button id="submit">Login with PIN</button>
    <div class="note">If you share your PIN and another device uses it, the PIN will be automatically revoked.</div>
    <div style="margin-top:10px; font-size:13px; text-align:center;">
      <a href="/payment" style="color:#9be7ff">Buy a course / Make payment</a>
    </div>
    <div id="msg" style="margin-top:10px;text-align:center"></div>
  </div>

<script>
  // generate a device id and store in localStorage (bound to this browser/device)
  function getDeviceId(){
    let id = localStorage.getItem("training_device_id");
    if(!id){
      id = 'dev-' + (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
      localStorage.setItem("training_device_id", id);
    }
    return id;
  }

  const pinEl = document.getElementById('pin');
  const msgEl = document.getElementById('msg');
  document.getElementById('submit').addEventListener('click', async () => {
    const pin = (pinEl.value || "").trim();
    if(pin.length !== 6 || !/^\d{6}$/.test(pin)){
      msgEl.innerHTML = '<span class="danger">Enter a valid 6-digit PIN</span>';
      return;
    }
    const device_id = getDeviceId();
    try{
      const res = await fetch('/api/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({pin, device_id})
      });
      const data = await res.json();
      if(data.success){
        alert("Welcome! You have successfully logged in. ⚡"); // welcome popup
        // show a small warning popup as requested
        setTimeout(()=>alert("Warning: PIN works on a single device. Do not share your PIN."), 300);
        // server set session cookie; redirect to dashboard
        window.location.href = "/dashboard";
      } else {
        msgEl.innerHTML = '<span class="danger">' + (data.message || data.error || 'Login failed') + '</span>';
      }
    }catch(e){
      msgEl.innerHTML = '<span class="danger">Network error</span>';
      console.error(e);
    }
  });

  // allow pressing Enter
  pinEl.addEventListener('keyup', e => {
    if(e.key === 'Enter') document.getElementById('submit').click();
  });
</script>
</body>
</html>
