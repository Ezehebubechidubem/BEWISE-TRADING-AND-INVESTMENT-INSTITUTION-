<!-- authentication.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Authentication — Crypto Training</title>
<link rel="icon" href="/logo.png">
<style>
  body{font-family:system-ui; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background:#071024; color:#e6eef8}
  .card{width:92vw; max-width:420px; padding:18px; border-radius:12px; background:linear-gradient(180deg,#071a2b,#041324)}
  .logo{display:block; width:140px; margin:0 auto 10px}
  .pin{width:100%; padding:12px; font-size:20px; text-align:center; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.06)}
  button{width:100%; padding:12px; margin-top:12px; border-radius:8px; border:0; background:#06b6d4; color:#042a2b; font-weight:700}
  .msg{margin-top:10px; text-align:center}
</style>
</head>
<body>
  <div class="card">
    <img src="/logo.png" class="logo" alt="logo">
    <h2 style="text-align:center">Enter 6-digit PIN</h2>
    <input id="pin" class="pin" maxlength="6" inputmode="numeric" placeholder="●●●●●●">
    <button id="btn">Login</button>
    <div class="msg" id="msg"></div>
    <p style="text-align:center; font-size:13px; margin-top:8px">If the PIN is used on another device it will be revoked automatically.</p>
    <p style="text-align:center"><a href="/payment" style="color:#9be7ff">Buy course / Payment</a></p>
  </div>

<script>
(async function(){
  // compute stable fingerprint (same method across pages)
  async function computeFP(){
    let uuid = localStorage.getItem('training_device_uuid');
    if(!uuid){ uuid = crypto.randomUUID ? crypto.randomUUID() : ('u-'+Math.random().toString(36).slice(2)); localStorage.setItem('training_device_uuid', uuid); }
    const data = [navigator.userAgent || '', navigator.platform || '', (navigator.languages || []).join(','), screen.width+'x'+screen.height+'x'+screen.colorDepth, Intl.DateTimeFormat().resolvedOptions().timeZone || '', uuid].join('||');
    const enc = new TextEncoder().encode(data);
    const hashBuf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  const fp = await computeFP();
  const msg = document.getElementById('msg');
  document.getElementById('btn').addEventListener('click', async ()=>{
    const pin = (document.getElementById('pin').value || '').trim();
    if(!/^\d{6}$/.test(pin)){ msg.innerText = 'Enter a valid 6-digit PIN'; return; }
    try {
      msg.innerText = 'Logging in...';
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ pin: pin, device_id: fp })
      });
      const j = await res.json();
      if(res.ok && j.success){
        alert('Welcome! Logged in.');
        setTimeout(()=>alert('Warning: PIN works on a single device. Do not share it.'), 200);
        if(pin === '891959'){
          sessionStorage.setItem('training_is_admin', '1');
          localStorage.setItem('training_allowed_device', fp); // client-side lock for convenience
          location.href = '/admin';
        } else {
          location.href = '/dashboard';
        }
      } else {
        msg.innerText = j.message || j.error || 'Login failed';
      }
    } catch(e){
      console.error(e);
      msg.innerText = 'Network error';
    }
  });
})();
</script>
</body>
</html>